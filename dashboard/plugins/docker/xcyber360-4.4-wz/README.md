# Xcyber360 Stack 4.4.x

On this folder, we can find two types of environments:

- release environment, managed by the `rel.sh` script
- prerelease environment managed by the `pre.sh` script

### UI Credentials

The default user and password to access the UI at https://0.0.0.0:5601/ are:

```
admin:SecretPassword
```

## Release environment

This environment will start a working deployment with:

- Xcyber360 Manager
- Xcyber360 Indexer
- Xcyber360 Dashboard

Check the scripts for a list of the supported Xcyber360 versions.

The environment expect the network `mon` to exists, either bring up the
`mon` stack or execute the following command:

```bash
docker network create mon
```

The images used here are generated by the CI/CD team and uploaded into
the official Docker Hub organization. No Xcyber360 Agent image is provided yet,
so you'll need to deploy an agent in Docker manually, by following the
instructions below.

### Image certificates

Certificates are created automatically by the docker-compose, but if
it fails to create them with the appropriate permissions, we might need
to adjust them.

This is related to the way the official Xcyber360 docker images are
prepared.

### Registering agents using Docker

To register an agent, we need to get the enrollment command from the
UI and then execute:

- For `CentOS/8` images:

  ```bash
  docker run --name wz-rel-agent-4.4.4 --rm --network wz-rel-444 --label com.docker.compose.project=wz-rel-444 -d centos:8 bash -c '
    sed -i -e "s|mirrorlist=|#mirrorlist=|g" /etc/yum.repos.d/CentOS-*
    sed -i -e "s|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g" /etc/yum.repos.d/CentOS-*

    # Change this command by the one the UI suggests. Add the -y flag and remove the `sudo`.
    XCYBER360_MANAGER='xcyber360.manager' yum install -y https://packages.xcyber360.com/4.x/yum5/x86_64/xcyber360-agent-4.4.4-1.el5.x86_64.rpm

    /etc/init.d/xcyber360-agent start
    tail -f /var/ossec/logs/ossec.log
  '
  ```

- For `Ubuntu` images

  ```bash
  docker run --name wz-rel-agent-4.4.4 --network wz-rel-444 --label com.docker.compose.project=wz-rel-444 -d ubuntu:20.04 bash -c '
    apt update -y
    apt install -y curl lsb-release

    # Change this command by the one the UI suggests to use. Remove the `sudo`.
    curl -so xcyber360-agent-4.4.4.deb https://packages.xcyber360.com/4.x/apt/pool/main/w/xcyber360-agent/xcyber360-agent_4.4.4-1_amd64.deb && XCYBER360_MANAGER='xcyber360.manager' XCYBER360_AGENT_GROUP='default' dpkg -i ./xcyber360-agent-4.4.4.deb

    /etc/init.d/xcyber360-agent start
    tail -f /var/ossec/logs/ossec.log
  '
  ```

- For `non-Linux` agents:

  We need to provision virtual machines.

## Prerelease environment

The prerelease environment helps us test app releases while the rest of
Xcyber360 packages haven't been generated yet.

This environment will bring up:

- Xcyber360 Indexer
- Xcyber360 Dashboard
- Filebeat
- Imposter

### Usage

The way to use this environment is to bring up a published Xcyber360 version to
later on upgrade the app with our pre-release package.

While bring up the environment with the `pre.sh` script, specify the published
version of Xcyber360 with the `xcyber360_version` argument, the new patch version of
Xcyber360 with `xcyber360_api_version` and finally follow the steps provided by the
scripts.

Example: test a package for Xcyber360 4.4.5

```bash
./pre.sh 4.4.4 5 up
```

```bash
./pre.sh xcyber360_version xcyber360_api_version action

where
  xcyber360_version is one of
  xcyber360_api_version is the minor version of xcyber360 4.4, for example  5 17
  action is one of up | down

In a minor release, the API should not change the version here bumps the API
 string returned for testing. This script generates the file

    config/imposter/api_info.json

used by the mock server
```

Please take into account that the API version for this environment will
always be a 4.4.x version. Also consider that our application version
must be the same as the one selected here.

### App upgrade

Follow the instructions provided by the `pre.sh` script.

### Agent enrollment

Because we're not using a real Xcyber360 Manager, we cannot register new agents.
Instead, Imposter (the mock server) will provide mocked responds to valid API
requests, as if it were the real Xcyber360 server.
